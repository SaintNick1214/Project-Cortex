name: PR Checks

on:
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize, reopened]

# Concurrency: Allow one workflow per PR, cancel in-progress on new commits
# Note: Tests now use parallel-safe isolation (TestRunContext), so concurrent
# test runs within the same workflow are safe.
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Default permissions: read-only
# Write permissions are granted explicitly at job level
permissions:
  contents: read

# IMPORTANT: Dependabot PRs are explicitly excluded from ALL jobs in this workflow
# Each job has a condition to skip when github.actor == 'dependabot[bot]'
# This prevents Dependabot from triggering any CI actions

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 1: Detect which files changed (fast, runs first)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  detect-changes:
    name: Detect File Changes
    runs-on: ubuntu-latest
    # Skip for Dependabot PRs (they only update dependencies)
    if: github.actor != 'dependabot[bot]'
    permissions:
      contents: read
      pull-requests: read
    outputs:
      typescript: ${{ steps.filter.outputs.typescript }}
      python: ${{ steps.filter.outputs.python }}
      vercel-ai-provider: ${{ steps.filter.outputs.vercel-ai-provider }}
      cli: ${{ steps.filter.outputs.cli }}
      convex: ${{ steps.filter.outputs.convex }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            typescript:
              - 'src/**'
              - 'tests/**'
              - 'package.json'
              - 'tsconfig.json'
              - 'jest.config.js'
            python:
              - 'cortex-sdk-python/**'
            vercel-ai-provider:
              - 'packages/vercel-ai-provider/**'
            cli:
              - 'packages/cortex-cli/**'
            convex:
              - 'convex-dev/**'

      - name: Show detected changes
        run: |
          echo "ğŸ“Š Detected Changes:"
          echo "  TypeScript SDK:      ${{ steps.filter.outputs.typescript }}"
          echo "  Python SDK:          ${{ steps.filter.outputs.python }}"
          echo "  Vercel AI Provider:  ${{ steps.filter.outputs.vercel-ai-provider }}"
          echo "  CLI:                 ${{ steps.filter.outputs.cli }}"
          echo "  Convex Backend:      ${{ steps.filter.outputs.convex }}"
          echo ""
          if [[ "${{ steps.filter.outputs.typescript }}" == "true" || \
                "${{ steps.filter.outputs.python }}" == "true" || \
                "${{ steps.filter.outputs.vercel-ai-provider }}" == "true" || \
                "${{ steps.filter.outputs.cli }}" == "true" || \
                "${{ steps.filter.outputs.convex }}" == "true" ]]; then
            echo "âœ… Tests will run for changed packages"
          else
            echo "â­ï¸  No testable changes detected - tests will be skipped"
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 2: Deploy Convex & Purge Database (runs once before all tests)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  setup-and-purge:
    name: Deploy & Purge Database
    runs-on: ubuntu-latest
    needs: detect-changes
    # Run if any tests need to run OR if targeting main branch
    if: |
      github.actor != 'dependabot[bot]' && (
        needs.detect-changes.outputs.typescript == 'true' ||
        needs.detect-changes.outputs.python == 'true' ||
        needs.detect-changes.outputs.vercel-ai-provider == 'true' ||
        needs.detect-changes.outputs.cli == 'true' ||
        needs.detect-changes.outputs.convex == 'true' ||
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Deploy Convex backend
        run: npx convex deploy --yes
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Purge test database
        run: |
          echo "ğŸ§¹ Purging all test data before parallel test execution..."
          npx tsx scripts/cleanup-test-data.ts
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 3: Code Quality (runs in parallel with tests after purge)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  code-quality:
    name: Code Quality (Lint & Type Check)
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-and-purge]
    # Run if TypeScript or Python files changed OR if PR is targeting main branch
    # IMPORTANT: Requires setup-and-purge to have SUCCEEDED (not just skipped) to ensure consistency with test jobs
    if: |
      always() &&
      github.actor != 'dependabot[bot]' &&
      needs.setup-and-purge.result == 'success' &&
      needs.detect-changes.result == 'success' &&
      (
        needs.detect-changes.outputs.typescript == 'true' || 
        needs.detect-changes.outputs.python == 'true' ||
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Node dependencies
        run: npm ci

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Run ESLint (TypeScript)
        if: needs.detect-changes.outputs.typescript == 'true' || github.event.pull_request.base.ref == 'main'
        run: npm run lint
        continue-on-error: false

      - name: Type check (TypeScript)
        if: needs.detect-changes.outputs.typescript == 'true' || github.event.pull_request.base.ref == 'main'
        run: npx tsc --noEmit

      - name: Install Python dev dependencies
        if: needs.detect-changes.outputs.python == 'true' || github.event.pull_request.base.ref == 'main'
        run: |
          cd cortex-sdk-python
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Type check with mypy (Python)
        if: needs.detect-changes.outputs.python == 'true' || github.event.pull_request.base.ref == 'main'
        run: |
          cd cortex-sdk-python
          mypy cortex --ignore-missing-imports

      - name: Lint with ruff (Python)
        if: needs.detect-changes.outputs.python == 'true' || github.event.pull_request.base.ref == 'main'
        run: |
          cd cortex-sdk-python
          ruff check cortex/

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 3: TypeScript SDK Tests (parallel with other test jobs)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test-typescript:
    name: Test TypeScript SDK
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-and-purge]
    # Run if TypeScript SDK or Convex backend changed OR if PR is targeting main branch
    # IMPORTANT: Requires setup-and-purge to have SUCCEEDED (not just skipped) to ensure database isolation
    if: |
      always() &&
      github.actor != 'dependabot[bot]' &&
      needs.setup-and-purge.result == 'success' &&
      needs.detect-changes.result == 'success' &&
      (
        needs.detect-changes.outputs.typescript == 'true' ||
        needs.detect-changes.outputs.convex == 'true' ||
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Run tests
        run: npm test
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Build package
        run: npm run build

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 3: Python SDK Tests (parallel with other test jobs, matrix across versions)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test-python:
    name: Test Python SDK
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-and-purge]
    # Run if Python SDK changed OR if PR is targeting main branch
    # IMPORTANT: Requires setup-and-purge to have SUCCEEDED (not just skipped) to ensure database isolation
    if: |
      always() &&
      github.actor != 'dependabot[bot]' &&
      needs.setup-and-purge.result == 'success' &&
      needs.detect-changes.result == 'success' &&
      (
        needs.detect-changes.outputs.python == 'true' || 
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
      max-parallel: 5 # Run all Python versions in parallel (parallel-safe)
      fail-fast: false

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          cd cortex-sdk-python
          python -m pip install --upgrade pip
          pip install python-dotenv
          pip install -e ".[dev]"

      # Stagger test starts to reduce concurrent load on shared Convex backend.
      # 5-second increments allow each runner to spin up and begin its test suite
      # before the next starts, avoiding thundering herd on database operations.
      - name: Stagger test start
        run: |
          case "${{ matrix.python-version }}" in
            "3.10") sleep 0 ;;
            "3.11") sleep 5 ;;
            "3.12") sleep 10 ;;
            "3.13") sleep 15 ;;
            "3.14") sleep 20 ;;
          esac

      - name: Run tests
        run: |
          cd cortex-sdk-python
          pytest tests/ -v --cov=cortex --cov-report=term-missing
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_TEST_MODE: managed
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 3: Vercel AI Provider Tests (parallel with other test jobs)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test-vercel-ai-provider:
    name: Test Vercel AI Provider
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-and-purge]
    # Run if Vercel AI Provider changed OR if PR is targeting main branch
    # IMPORTANT: Requires setup-and-purge to have SUCCEEDED (not just skipped) to ensure database isolation
    if: |
      always() &&
      github.actor != 'dependabot[bot]' &&
      needs.setup-and-purge.result == 'success' &&
      needs.detect-changes.result == 'success' &&
      (
        needs.detect-changes.outputs.vercel-ai-provider == 'true' || 
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Build main SDK first
        run: npm run build

      - name: Install Vercel AI Provider dependencies
        run: |
          cd packages/vercel-ai-provider
          npm install

      - name: Run Vercel AI Provider tests
        run: |
          cd packages/vercel-ai-provider
          npm test

      - name: Lint Vercel AI Provider
        run: |
          cd packages/vercel-ai-provider
          npm run lint

      - name: Build Vercel AI Provider
        run: |
          cd packages/vercel-ai-provider
          npm run build

      - name: Verify package contents
        run: |
          cd packages/vercel-ai-provider
          npm pack --dry-run

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 3: CLI Tests (parallel with other test jobs)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test-cli:
    name: Test Cortex CLI
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-and-purge]
    # Run if CLI changed OR if PR is targeting main branch
    # IMPORTANT: Requires setup-and-purge to have SUCCEEDED (not just skipped) to ensure database isolation
    if: |
      always() &&
      github.actor != 'dependabot[bot]' &&
      needs.setup-and-purge.result == 'success' &&
      needs.detect-changes.result == 'success' &&
      (
        needs.detect-changes.outputs.cli == 'true' || 
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Build main SDK first
        run: npm run build

      - name: Install CLI dependencies
        run: |
          cd packages/cortex-cli
          npm install

      - name: Run CLI unit tests
        run: |
          cd packages/cortex-cli
          npm run test:unit
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}

      - name: Run CLI integration tests
        run: |
          cd packages/cortex-cli
          npm run test:integration
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Lint CLI
        run: |
          cd packages/cortex-cli
          npm run lint

      - name: Build CLI
        run: |
          cd packages/cortex-cli
          npm run build

      - name: Verify package contents
        run: |
          cd packages/cortex-cli
          npm pack --dry-run

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGE 4: All Checks Passed (final gate)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  all-checks-passed:
    name: All Checks Passed
    needs:
      [
        detect-changes,
        setup-and-purge,
        test-typescript,
        test-python,
        test-vercel-ai-provider,
        test-cli,
        code-quality,
      ]
    # Skip for Dependabot PRs (they don't run any checks)
    if: always() && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check if all jobs passed
        run: |
          echo "ğŸ“Š Check Results:"
          echo "  Detect Changes:           ${{ needs.detect-changes.result }}"
          echo "  Setup & Purge:            ${{ needs.setup-and-purge.result }}"
          echo "  Code Quality:             ${{ needs.code-quality.result }}"
          echo "  TypeScript Tests:         ${{ needs.test-typescript.result }}"
          echo "  Python Tests:             ${{ needs.test-python.result }}"
          echo "  Vercel AI Provider Tests: ${{ needs.test-vercel-ai-provider.result }}"
          echo "  CLI Tests:                ${{ needs.test-cli.result }}"
          echo ""
          echo "â„¹ï¸  Security scans run in separate workflow (see Security tab)"
          echo ""

          # Detect changes must pass (it's the root job)
          if [[ "${{ needs.detect-changes.result }}" == "failure" ]]; then
            echo "âŒ Detect changes failed"
            exit 1
          fi

          # Setup & purge must pass if it ran
          if [[ "${{ needs.setup-and-purge.result }}" == "failure" ]]; then
            echo "âŒ Setup & purge failed"
            exit 1
          fi

          # Validate that tests ran when they should have
          # If setup-and-purge succeeded, tests should not be skipped (they should pass or fail)
          if [[ "${{ needs.setup-and-purge.result }}" == "success" ]]; then
            # Check TypeScript tests
            if [[ ("${{ needs.detect-changes.outputs.typescript }}" == "true" || \
                   "${{ needs.detect-changes.outputs.convex }}" == "true" || \
                   "${{ github.event.pull_request.base.ref }}" == "main") && \
                  "${{ needs.test-typescript.result }}" == "skipped" ]]; then
              echo "âŒ TypeScript tests should have run but were skipped"
              exit 1
            fi

            # Check Python tests
            if [[ ("${{ needs.detect-changes.outputs.python }}" == "true" || \
                   "${{ github.event.pull_request.base.ref }}" == "main") && \
                  "${{ needs.test-python.result }}" == "skipped" ]]; then
              echo "âŒ Python tests should have run but were skipped"
              exit 1
            fi

            # Check Vercel AI Provider tests
            if [[ ("${{ needs.detect-changes.outputs.vercel-ai-provider }}" == "true" || \
                   "${{ github.event.pull_request.base.ref }}" == "main") && \
                  "${{ needs.test-vercel-ai-provider.result }}" == "skipped" ]]; then
              echo "âŒ Vercel AI Provider tests should have run but were skipped"
              exit 1
            fi

            # Check CLI tests
            if [[ ("${{ needs.detect-changes.outputs.cli }}" == "true" || \
                   "${{ github.event.pull_request.base.ref }}" == "main") && \
                  "${{ needs.test-cli.result }}" == "skipped" ]]; then
              echo "âŒ CLI tests should have run but were skipped"
              exit 1
            fi

            # Check code quality
            if [[ ("${{ needs.detect-changes.outputs.typescript }}" == "true" || \
                   "${{ needs.detect-changes.outputs.python }}" == "true" || \
                   "${{ github.event.pull_request.base.ref }}" == "main") && \
                  "${{ needs.code-quality.result }}" == "skipped" ]]; then
              echo "âŒ Code quality checks should have run but were skipped"
              exit 1
            fi
          fi

          # Code quality must pass OR be skipped (when no changes)
          if [[ "${{ needs.code-quality.result }}" == "failure" ]]; then
            echo "âŒ Code quality check failed"
            exit 1
          fi

          # TypeScript tests must pass OR be skipped (when no changes)
          if [[ "${{ needs.test-typescript.result }}" == "failure" ]]; then
            echo "âŒ TypeScript tests failed"
            exit 1
          fi

          # Python tests must pass OR be skipped (when no changes)
          if [[ "${{ needs.test-python.result }}" == "failure" ]]; then
            echo "âŒ Python tests failed"
            exit 1
          fi

          # Vercel AI Provider tests must pass OR be skipped (when no changes)
          if [[ "${{ needs.test-vercel-ai-provider.result }}" == "failure" ]]; then
            echo "âŒ Vercel AI Provider tests failed"
            exit 1
          fi

          # CLI tests must pass OR be skipped (when no changes)
          if [[ "${{ needs.test-cli.result }}" == "failure" ]]; then
            echo "âŒ CLI tests failed"
            exit 1
          fi

          echo ""
          echo "âœ… All PR checks passed!"
