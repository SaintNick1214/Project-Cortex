name: PR Checks

on:
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize, reopened]

# Prevent parallel execution to avoid Convex deployment conflicts
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Default permissions: read-only
# Write permissions are granted explicitly at job level
permissions:
  contents: read

jobs:
  # Code quality check (fast - runs first)
  code-quality:
    name: Code Quality (Lint & Type Check)
    runs-on: ubuntu-latest
    needs: detect-changes
    # Run if TypeScript SDK version changed OR if PR is targeting main branch
    # Skip for Dependabot PRs (they only update dependencies)
    if: |
      github.actor != 'dependabot[bot]' && (
        needs.detect-changes.outputs.typescript == 'true' || 
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Deploy Convex backend
        run: npx convex deploy --yes
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Type check
        run: npx tsc --noEmit

  # TypeScript/JavaScript SDK Tests
  test-typescript:
    name: Test TypeScript SDK
    runs-on: ubuntu-latest
    needs: detect-changes
    # Run if TypeScript SDK version changed OR if PR is targeting main branch
    # Skip for Dependabot PRs (they only update dependencies)
    if: |
      github.actor != 'dependabot[bot]' && (
        needs.detect-changes.outputs.typescript == 'true' || 
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Deploy Convex backend
        run: npx convex deploy --yes
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Run tests
        run: npm test
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Build package
        run: npm run build

  # Detect version changes
  detect-changes:
    name: Detect Version Changes
    runs-on: ubuntu-latest
    # Skip for Dependabot PRs (they only update dependencies)
    if: github.actor != 'dependabot[bot]'
    permissions:
      contents: read
    outputs:
      typescript: ${{ steps.check-versions.outputs.typescript-changed }}
      python: ${{ steps.check-versions.outputs.python-changed }}
      vercel-ai-provider: ${{ steps.check-versions.outputs.vercel-ai-provider-changed }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Check version numbers
        id: check-versions
        run: |
          # Check TypeScript SDK version
          TS_VERSION=$(node -p "require('./package.json').version")
          echo "üì¶ PR TypeScript SDK version: $TS_VERSION"

          TS_NPM_VERSION=$(npm view @cortexmemory/sdk version 2>/dev/null || echo "0.0.0")
          echo "üìö Published TypeScript SDK version: $TS_NPM_VERSION"

          if [ "$TS_VERSION" != "$TS_NPM_VERSION" ]; then
            echo "typescript-changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ TypeScript SDK version changed: $TS_NPM_VERSION ‚Üí $TS_VERSION"
          else
            echo "typescript-changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  TypeScript SDK version unchanged: $TS_VERSION"
          fi

          # Check Python SDK version
          cd cortex-sdk-python
          PYTHON_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "üì¶ PR Python SDK version: $PYTHON_VERSION"

          pip install --upgrade pip > /dev/null 2>&1
          PYTHON_NPM_VERSION=$(pip index versions cortex-memory 2>/dev/null | grep "cortex-memory" | head -1 | sed 's/.*(\(.*\))/\1/' || echo "0.0.0")
          echo "üìö Published Python SDK version: $PYTHON_NPM_VERSION"

          if [ "$PYTHON_VERSION" != "$PYTHON_NPM_VERSION" ]; then
            echo "python-changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Python SDK version changed: $PYTHON_NPM_VERSION ‚Üí $PYTHON_VERSION"
          else
            echo "python-changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  Python SDK version unchanged: $PYTHON_VERSION"
          fi

          # Check Vercel AI Provider version
          cd ..
          cd packages/vercel-ai-provider
          VERCEL_VERSION=$(node -p "require('./package.json').version")
          echo "üì¶ PR Vercel AI Provider version: $VERCEL_VERSION"

          VERCEL_NPM_VERSION=$(npm view @cortexmemory/vercel-ai-provider version 2>/dev/null || echo "0.0.0")
          echo "üìö Published Vercel AI Provider version: $VERCEL_NPM_VERSION"

          if [ "$VERCEL_VERSION" != "$VERCEL_NPM_VERSION" ]; then
            echo "vercel-ai-provider-changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Vercel AI Provider version changed: $VERCEL_NPM_VERSION ‚Üí $VERCEL_VERSION"
          else
            echo "vercel-ai-provider-changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  Vercel AI Provider version unchanged: $VERCEL_VERSION"
          fi

  # Python SDK Tests
  test-python:
    name: Test Python SDK
    runs-on: ubuntu-latest
    needs: [detect-changes, test-typescript] # Wait for TS tests to avoid Convex conflicts
    # Run if Python SDK version changed OR if PR is targeting main branch
    if: |
      needs.detect-changes.outputs.python == 'true' || 
      github.event.pull_request.base.ref == 'main'
    permissions:
      contents: read

    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
      max-parallel: 1

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          cd cortex-sdk-python
          python -m pip install --upgrade pip
          pip install python-dotenv
          pip install -e ".[dev]"

      - name: Run tests
        run: |
          cd cortex-sdk-python
          pytest tests/ -v --cov=cortex --cov-report=term-missing
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_TEST_MODE: managed
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Check types with mypy
        run: |
          cd cortex-sdk-python
          mypy cortex --ignore-missing-imports

      - name: Lint with ruff
        run: |
          cd cortex-sdk-python
          ruff check cortex/

  # Vercel AI Provider Tests
  test-vercel-ai-provider:
    name: Test Vercel AI Provider
    runs-on: ubuntu-latest
    needs: detect-changes
    # Run if Vercel AI Provider version changed OR if PR is targeting main branch
    # Skip for Dependabot PRs (they only update dependencies)
    if: |
      github.actor != 'dependabot[bot]' && (
        needs.detect-changes.outputs.vercel-ai-provider == 'true' || 
        github.event.pull_request.base.ref == 'main'
      )
    permissions:
      contents: read

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Deploy Convex backend
        run: npx convex deploy --yes
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Generate Convex types
        run: npx convex codegen
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Build main SDK first
        run: npm run build

      - name: Install Vercel AI Provider dependencies
        run: |
          cd packages/vercel-ai-provider
          npm install

      - name: Run Vercel AI Provider tests
        run: |
          cd packages/vercel-ai-provider
          npm test

      - name: Lint Vercel AI Provider
        run: |
          cd packages/vercel-ai-provider
          npm run lint

      - name: Build Vercel AI Provider
        run: |
          cd packages/vercel-ai-provider
          npm run build

      - name: Verify package contents
        run: |
          cd packages/vercel-ai-provider
          npm pack --dry-run

  # Note: Comprehensive security scans run in security.yml workflow
  # This keeps PR checks fast while security scans run separately

  # All checks passed
  all-checks-passed:
    name: All Checks Passed
    needs:
      [
        detect-changes,
        test-typescript,
        test-python,
        test-vercel-ai-provider,
        code-quality,
      ]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check if all jobs passed
        run: |
          echo "üìä Check Results:"
          echo "  Code Quality: ${{ needs.code-quality.result }}"
          echo "  TypeScript Tests: ${{ needs.test-typescript.result }}"
          echo "  Python Tests: ${{ needs.test-python.result }}"
          echo "  Vercel AI Provider Tests: ${{ needs.test-vercel-ai-provider.result }}"
          echo ""
          echo "‚ÑπÔ∏è  Security scans run in separate workflow (see Security tab)"
          echo ""

          # Code quality must pass OR be skipped (when TS version unchanged)
          if [[ "${{ needs.code-quality.result }}" == "failure" ]]; then
            echo "‚ùå Code quality check failed"
            exit 1
          fi

          # TypeScript tests must pass OR be skipped (when TS version unchanged)
          if [[ "${{ needs.test-typescript.result }}" == "failure" ]]; then
            echo "‚ùå TypeScript tests failed"
            exit 1
          fi

          # Python tests must pass OR be skipped (when Python version unchanged)
          if [[ "${{ needs.test-python.result }}" == "failure" ]]; then
            echo "‚ùå Python tests failed"
            exit 1
          fi

          # Vercel AI Provider tests must pass OR be skipped (when version unchanged)
          if [[ "${{ needs.test-vercel-ai-provider.result }}" == "failure" ]]; then
            echo "‚ùå Vercel AI Provider tests failed"
            exit 1
          fi

          echo ""
          echo "‚úÖ All PR checks passed!"
