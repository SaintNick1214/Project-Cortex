version: '3.8'

services:
  # Neo4j Community Edition
  # Cypher query language, Bolt protocol on port 7687
  # Web UI available at http://localhost:7474
  neo4j:
    image: neo4j:5-community
    container_name: cortex-neo4j
    ports:
      - "7474:7474"  # HTTP (Browser UI)
      - "7687:7687"  # Bolt (Query Protocol)
    environment:
      # Authentication
      - NEO4J_AUTH=neo4j/cortex-dev-password
      
      # Plugins
      - NEO4J_PLUGINS=["apoc"]
      
      # Memory settings (adjust based on your system)
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
      
      # Accept license
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-plugins:/plugins
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Memgraph
  # Cypher-compatible, Bolt protocol on port 7688 (to avoid Neo4j conflict)
  # Memgraph Lab available at http://localhost:3001
  memgraph:
    image: memgraph/memgraph:latest
    container_name: cortex-memgraph
    ports:
      - "7688:7687"  # Bolt (mapped to 7688 on host to avoid Neo4j conflict)
      - "3001:3000"  # Memgraph Lab UI (mapped to 3001 on host)
    environment:
      # Authentication (Memgraph 2.0+)
      - MEMGRAPH_USER=memgraph
      - MEMGRAPH_PASSWORD=cortex-dev-password
    volumes:
      - memgraph-data:/var/lib/memgraph
      - memgraph-log:/var/log/memgraph
      - memgraph-etc:/etc/memgraph
    command: ["--bolt-port=7687", "--log-level=WARNING"]
    healthcheck:
      test: ["CMD-SHELL", "echo 'RETURN 1;' | mgconsole --host 127.0.0.1 --port 7687 --username memgraph --password cortex-dev-password || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

volumes:
  # Neo4j volumes
  neo4j-data:
    name: cortex-neo4j-data
  neo4j-logs:
    name: cortex-neo4j-logs
  neo4j-import:
    name: cortex-neo4j-import
  neo4j-plugins:
    name: cortex-neo4j-plugins
  
  # Memgraph volumes
  memgraph-data:
    name: cortex-memgraph-data
  memgraph-log:
    name: cortex-memgraph-log
  memgraph-etc:
    name: cortex-memgraph-etc

networks:
  default:
    name: cortex-graph-network

